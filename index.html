<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CINELEVI Watch Party</title>
    <!-- Tailwind CSS CDN for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            /* Prevents horizontal scrolling */
            overflow-x: hidden;
        }

        /* Custom styles for the sidebar menu */
        .sidebar {
            width: 100%;
            max-width: 300px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .video-player {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #1a1a1a;
            border-radius: 0.5rem;
        }

        .loading-icon {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom scrollbar for the chat container */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background-color: #4a4a4a;
            border-radius: 10px;
            border: 2px solid #1a1a1a;
        }

        /* Mobile specific styles to prevent horizontal scroll */
        .app-content {
            padding-top: 60px; /* Adjust for fixed header */
        }
    </style>
</head>
<body class="bg-black text-white antialiased">

    <!-- Loading and Error Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-black flex flex-col items-center justify-center z-50">
        <div id="loading-spinner" class="loading-icon w-16 h-16 mb-4"></div>
        <p id="loading-text" class="text-white text-lg font-semibold">A carregar...</p>
        <p id="error-message" class="text-red-500 text-sm mt-4 hidden"></p>
    </div>

    <!-- Notification message (replaces alert()) -->
    <div id="notification-box" class="fixed top-4 left-1/2 -translate-x-1/2 bg-black text-white py-2 px-4 rounded-lg shadow-lg hidden z-50 border border-white">
        <p id="notification-message"></p>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen flex flex-col justify-center items-center" style="display: none;">

        <!-- Header for the main app -->
        <header class="w-full fixed top-0 left-0 z-40 bg-black border-b border-gray-800">
            <div class="max-w-6xl mx-auto flex justify-between items-center px-4 py-3">
                <button id="open-sidebar-btn" aria-label="Abrir menu lateral" class="text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold">CINELEVI</h1>
                <div class="w-7 h-7"></div> <!-- Spacer for centering -->
            </div>
        </header>

        <!-- Sidebar menu with an overlay effect -->
        <div id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-gray-900 shadow-xl p-6 transition-transform duration-300 ease-in-out flex flex-col items-center">
            <!-- Close button -->
            <button id="close-sidebar-btn" aria-label="Fechar menu lateral" class="absolute top-4 right-4 text-white hover:text-gray-400 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-xl font-bold mb-6 mt-12">Detalhes do Perfil</h2>
            <img id="profile-pic-sidebar" src="https://placehold.co/128x128/333/fff?text=P" alt="Profile Picture" class="w-32 h-32 rounded-full border-2 border-white mb-4">
            <p id="profile-name-sidebar" class="text-lg font-semibold mb-2"></p>
            <p id="profile-email-sidebar" class="text-sm text-gray-400 mb-8"></p>

            <button id="edit-profile-btn" class="w-full bg-gray-800 text-white rounded-md py-2 px-4 mb-4 hover:bg-gray-700 transition-colors">
                Editar Perfil
            </button>
            <button id="logout-btn" class="w-full bg-red-600 text-white rounded-md py-2 px-4 hover:bg-red-500 transition-colors">
                Sair da Conta
            </button>
        </div>

        <!-- Main lobby content -->
        <div class="app-content flex-grow w-full max-w-6xl mx-auto flex flex-col items-center p-4">
            
            <!-- Video player container with custom fullscreen button -->
            <div class="relative w-full aspect-video bg-black rounded-lg mb-4">
                <video id="video-player" class="w-full h-full rounded-lg" controls playsinline></video>
                <button id="fullscreen-btn" class="absolute bottom-4 right-4 bg-gray-800 bg-opacity-50 text-white p-2 rounded-md hover:bg-opacity-75 transition-colors focus:outline-none" aria-label="Entrar em tela cheia">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 16.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                    </svg>
                </button>
            </div>

            <!-- Player controls and link input -->
            <div class="w-full flex flex-col md:flex-row items-center mb-4 space-y-2 md:space-y-0 md:space-x-2">
                <input id="video-url-input" type="text" placeholder="Cole o link do vídeo MP4 aqui..." class="flex-grow px-4 py-3 bg-gray-800 text-white rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-white">
                <button id="load-video-btn" class="shrink-0 px-4 py-3 bg-white text-black font-semibold rounded-md hover:bg-gray-200 transition-colors flex items-center justify-center" disabled>
                    <span id="load-video-text">Carregar Vídeo</span>
                    <div id="load-video-loading" class="loading-icon hidden ml-2"></div>
                </button>
            </div>

            <!-- Chat -->
            <div class="w-full bg-gray-900 rounded-lg p-4 flex flex-col h-96">
                <div id="chat-messages" class="chat-container flex-grow overflow-y-auto space-y-4 mb-4">
                    <p id="chat-placeholder" class="text-gray-500 text-center">Nenhuma mensagem ainda. Comece a conversar!</p>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="chat-input" type="text" placeholder="Envie uma mensagem..." class="flex-grow px-4 py-3 bg-gray-800 text-white rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-white">
                    <button id="send-chat-btn" class="shrink-0 px-4 py-3 bg-white text-black font-semibold rounded-md hover:bg-gray-200 transition-colors flex items-center justify-center" disabled>
                        <span id="send-chat-text">Enviar</span>
                        <div id="send-chat-loading" class="loading-icon hidden ml-2"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Authentication Form -->
    <div id="auth-form" class="flex flex-col items-center justify-center min-h-screen p-4 bg-black" style="display: none;">
        <div class="w-full max-w-2xl rounded-lg shadow-lg p-6">
            <h2 id="auth-title" class="text-4xl font-extrabold mb-8 text-center text-white">LOGIN</h2>
            <form id="login-form" class="space-y-6">
                <input id="email-input" type="email" placeholder="E-mail" required class="w-full px-4 py-4 bg-gray-800 text-white rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-white text-lg">
                <div class="relative">
                    <input id="password-input" type="password" placeholder="Senha" required class="w-full px-4 py-4 pr-16 bg-gray-800 text-white rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-white text-lg">
                    <button type="button" id="toggle-password-visibility-btn" aria-label="Alternar visibilidade da senha" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-white">
                        <svg id="eye-open-icon" class="h-8 w-8 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg id="eye-closed-icon" class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7L.458 12c1.274-4.057 5.064-7 9.542-7a10.05 10.05 0 011.875.175M12 12c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21L3 3" />
                        </svg>
                    </button>
                </div>
                <button type="submit" id="auth-button" class="w-full bg-white text-black font-semibold rounded-md py-4 hover:bg-gray-200 transition-colors flex items-center justify-center text-lg">
                    <span id="auth-button-text">Entrar</span>
                    <div id="auth-button-loading" class="loading-icon hidden ml-2"></div>
                </button>
            </form>
            <p class="text-sm text-center text-gray-400 mt-4">
                Não tem uma conta? <button id="toggle-auth-btn" class="text-white hover:underline focus:outline-none">Cadastre-se</button>
            </p>
        </div>
    </div>

    <!-- Profile Form (appears after sign-up) -->
    <div id="profile-form" class="flex-col items-center justify-center min-h-screen p-4" style="display: none;">
        <h1 class="text-3xl font-bold mb-8 text-center text-white">Configure seu Perfil</h1>
        <div class="w-full max-w-sm bg-gray-900 rounded-lg shadow-lg p-6">
            <form id="setup-profile-form" class="space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <img id="preview-profile-pic" src="https://placehold.co/128x128/333/fff?text=P" alt="Profile Picture" class="w-32 h-32 rounded-full border-2 border-white mb-4">
                    <label for="profile-pic-upload" class="bg-gray-800 text-white py-2 px-4 rounded-md cursor-pointer hover:bg-gray-700 transition-colors">
                        Escolher Foto de Perfil
                    </label>
                    <input type="file" id="profile-pic-upload" accept="image/*" class="hidden">
                </div>
                <input id="display-name-input" type="text" placeholder="Seu nome ou apelido" required class="w-full px-4 py-3 bg-gray-800 text-white rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-white">
                <button type="submit" id="setup-profile-btn" class="w-full bg-white text-black font-semibold rounded-md py-3 hover:bg-gray-200 transition-colors flex items-center justify-center">
                    <span id="setup-profile-text">Salvar e Continuar</span>
                    <div id="setup-profile-loading" class="loading-icon hidden ml-2"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 p-6 rounded-lg shadow-xl text-center">
            <h3 class="text-xl font-bold mb-4">Tem certeza que deseja sair?</h3>
            <div class="flex justify-center space-x-4">
                <button id="confirm-logout-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-500 transition-colors">Sair</button>
                <button id="cancel-logout-btn" class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-500 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        window.onload = function() {
            // Environment variables
            const appId = 'CINELEVI';
            const firebaseConfig = {
                apiKey: "AIzaSyAJ5QedjWWrAvyOfojHAGNpj7MJT3asDms",
                authDomain: "cinewatch-a5a43.firebaseapp.com",
                projectId: "cinewatch-a5a43",
                storageBucket: "cinewatch-a5a43.appspot.com",
                messagingSenderId: "375791940451",
                appId: "1:375791940451:web:a5ec82a1dfb5a1e2019956"
            };

            // ImgBB API Key and URL
            const imgbbAPIKey = '9a792241a6220ed358215ad0c1e4162e';
            const imgbbUploadURL = `https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`;

            // References to DOM elements
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            const errorMessage = document.getElementById('error-message');
            const appContainer = document.getElementById('app-container');
            const authForm = document.getElementById('auth-form');
            const profileForm = document.getElementById('profile-form');
            const authButton = document.getElementById('auth-button');
            const toggleAuthBtn = document.getElementById('toggle-auth-btn');
            const authTitle = document.getElementById('auth-title');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const setupProfileForm = document.getElementById('setup-profile-form');
            const displayNameInput = document.getElementById('display-name-input');
            const profilePicUpload = document.getElementById('profile-pic-upload');
            const previewProfilePic = document.getElementById('preview-profile-pic');
            const setupProfileBtn = document.getElementById('setup-profile-btn');
            const videoPlayer = document.getElementById('video-player');
            const videoUrlInput = document.getElementById('video-url-input');
            const loadVideoBtn = document.getElementById('load-video-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebar = document.getElementById('sidebar');
            const profileNameSidebar = document.getElementById('profile-name-sidebar');
            const profileEmailSidebar = document.getElementById('profile-email-sidebar');
            const profilePicSidebar = document.getElementById('profile-pic-sidebar');
            const logoutBtn = document.getElementById('logout-btn');
            const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility-btn');
            const eyeOpenIcon = document.getElementById('eye-open-icon');
            const eyeClosedIcon = document.getElementById('eye-closed-icon');
            const logoutModal = document.getElementById('logout-modal');
            const confirmLogoutBtn = document.getElementById('confirm-logout-btn');
            const cancelLogoutBtn = document.getElementById('cancel-logout-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');

            // References for loading states
            const authButtonText = document.getElementById('auth-button-text');
            const authButtonLoading = document.getElementById('auth-button-loading');
            const setupProfileText = document.getElementById('setup-profile-text');
            const setupProfileLoading = document.getElementById('setup-profile-loading');
            const loadVideoText = document.getElementById('load-video-text');
            const loadVideoLoading = document.getElementById('load-video-loading');
            const sendChatText = document.getElementById('send-chat-text');
            const sendChatLoading = document.getElementById('send-chat-loading');
            
            // App state and room document reference
            let currentRoomDocRef = null;
            let currentUserData = null;
            let isSetupMode = false;
            let renderedMessageIds = new Set(); // To prevent message duplicates on re-render
            let chatMessagesInitialized = false;

            // Debounce function to limit rapid updates
            function debounce(func, timeout = 500) {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => { func.apply(this, args); }, timeout);
                };
            }

            // Function to show notifications
            function showNotification(message) {
                const notificationBox = document.getElementById('notification-box');
                const notificationMessage = document.getElementById('notification-message');
                notificationMessage.textContent = message;
                notificationBox.classList.remove('hidden');
                setTimeout(() => {
                    notificationBox.classList.add('hidden');
                }, 3000);
            }

            // Function to toggle a button's loading state
            function setButtonLoading(button, textSpan, loadingIcon, isLoading) {
                if (isLoading) {
                    textSpan.classList.add('hidden');
                    loadingIcon.classList.remove('hidden');
                    button.disabled = true;
                } else {
                    textSpan.classList.remove('hidden');
                    loadingIcon.classList.add('hidden');
                    button.disabled = false;
                }
            }

            // Function to load and show the correct screen
            function showScreen(screenId) {
                authForm.style.display = 'none';
                profileForm.style.display = 'none';
                appContainer.style.display = 'none';
                loadingScreen.classList.add('hidden');

                if (screenId === 'auth') {
                    authForm.style.display = 'flex';
                } else if (screenId === 'profile') {
                    profileForm.style.display = 'flex';
                } else if (screenId === 'app') {
                    appContainer.style.display = 'flex';
                }
            }

            // --- Initialize Firebase and handle loading state ---
            let auth, db;
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                loadingText.textContent = "Erro na inicialização.";
                errorMessage.textContent = `Erro: ${error.message}`;
                errorMessage.classList.remove('hidden');
                return; // Prevents the rest of the code from running
            }

            // --- Authentication Logic ---
            toggleAuthBtn.addEventListener('click', () => {
                isSetupMode = !isSetupMode;
                if (isSetupMode) {
                    authTitle.textContent = 'CADASTRAR';
                    authButtonText.textContent = 'Cadastrar';
                    toggleAuthBtn.textContent = 'Já tem uma conta? Entrar';
                } else {
                    authTitle.textContent = 'LOGIN';
                    authButtonText.textContent = 'Entrar';
                    toggleAuthBtn.textContent = 'Não tem uma conta? Cadastre-se';
                }
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                setButtonLoading(authButton, authButtonText, authButtonLoading, true);

                try {
                    if (isSetupMode) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    showNotification(`Erro: ${error.message}`);
                    console.error(error);
                } finally {
                    setButtonLoading(authButton, authButtonText, authButtonLoading, false);
                }
            });

            // Toggle password visibility
            togglePasswordVisibilityBtn.addEventListener('click', () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeOpenIcon.classList.remove('hidden');
                    eyeClosedIcon.classList.add('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeOpenIcon.classList.add('hidden');
                    eyeClosedIcon.classList.remove('hidden');
                }
            });


            // --- Profile Setup Logic ---
            profilePicUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewProfilePic.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            setupProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const displayName = displayNameInput.value;
                const profilePicFile = profilePicUpload.files[0];
                setButtonLoading(setupProfileBtn, setupProfileText, setupProfileLoading, true);

                try {
                    const user = auth.currentUser;
                    let photoURL = '';

                    if (profilePicFile) {
                        try {
                            const formData = new FormData();
                            formData.append('image', profilePicFile);
                            const response = await fetch(imgbbUploadURL, {
                                method: 'POST',
                                body: formData
                            });
                            const result = await response.json();
                            if (result.success) {
                                photoURL = result.data.url;
                            } else {
                                throw new Error('Falha ao fazer upload da imagem para o ImgBB');
                            }
                        } catch (imgbbError) {
                            console.error("Erro no upload para ImgBB:", imgbbError);
                            showNotification("Erro ao enviar a imagem. O perfil será salvo sem foto.");
                        }
                    }

                    const userDocRef = doc(db, 'users', user.uid);
                    await setDoc(userDocRef, {
                        displayName: displayName || 'Usuário Cinelevi',
                        photoURL: photoURL || '',
                        createdAt: serverTimestamp()
                    });

                    showNotification('Perfil salvo com sucesso!');
                    showScreen('app');
                } catch (error) {
                    showNotification(`Erro ao salvar perfil: ${error.message}`);
                    console.error(error);
                } finally {
                    setButtonLoading(setupProfileBtn, setupProfileText, setupProfileLoading, false);
                }
            });

            // --- Sidebar Logic ---
            openSidebarBtn.addEventListener('click', () => {
                sidebar.classList.add('open');
            });

            closeSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('open');
            });

            logoutBtn.addEventListener('click', () => {
                logoutModal.classList.remove('hidden');
            });

            confirmLogoutBtn.addEventListener('click', async () => {
                logoutModal.classList.add('hidden');
                try {
                    await signOut(auth);
                    showNotification('Sessão encerrada.');
                } catch (error) {
                    showNotification(`Erro ao sair: ${error.message}`);
                    console.error(error);
                }
            });

            cancelLogoutBtn.addEventListener('click', () => {
                logoutModal.classList.add('hidden');
            });

            // Custom fullscreen button logic
            fullscreenBtn.addEventListener('click', () => {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen();
                } else if (videoPlayer.webkitRequestFullscreen) { /* Safari */
                    videoPlayer.webkitRequestFullscreen();
                } else if (videoPlayer.msRequestFullscreen) { /* IE11 */
                    videoPlayer.msRequestFullscreen();
                }
            });

            // --- Lobby and Sync Logic ---
            loadVideoBtn.addEventListener('click', async () => {
                if (!currentRoomDocRef) {
                    showNotification('Aguarde, a sala ainda não está pronta.');
                    return;
                }
                const url = videoUrlInput.value.trim();
                if (!url.toLowerCase().endsWith('.mp4')) {
                    showNotification('Por favor, insira um link de vídeo MP4 válido.');
                    return;
                }
                setButtonLoading(loadVideoBtn, loadVideoText, loadVideoLoading, true);
                
                try {
                    await setDoc(currentRoomDocRef, {
                        videoURL: url,
                        isPlaying: true,
                        timestamp: 0,
                        lastUpdatedBy: auth.currentUser.uid,
                        lastUpdateTimestamp: new Date().getTime()
                    });
                    showNotification('Vídeo carregado com sucesso!');
                } catch (error) {
                    showNotification(`Erro ao carregar vídeo: ${error.message}`);
                    console.error(error);
                } finally {
                    setButtonLoading(loadVideoBtn, loadVideoText, loadVideoLoading, false);
                }
            });

            // Sync video player state with Firestore using debounce
            const updateRoomState = debounce(async (state) => {
                if (!currentRoomDocRef || !auth.currentUser) return;
                try {
                    await updateDoc(currentRoomDocRef, {
                        ...state,
                        lastUpdatedBy: auth.currentUser.uid,
                        lastUpdateTimestamp: new Date().getTime()
                    });
                } catch(e) {
                    console.error("Erro ao sincronizar estado do player:", e);
                }
            });

            videoPlayer.addEventListener('play', () => updateRoomState({ isPlaying: true, timestamp: videoPlayer.currentTime }));
            videoPlayer.addEventListener('pause', () => updateRoomState({ isPlaying: false, timestamp: videoPlayer.currentTime }));
            videoPlayer.addEventListener('seeked', () => updateRoomState({ timestamp: videoPlayer.currentTime }));
            
            // --- Chat Logic ---
            document.getElementById('send-chat-btn').addEventListener('click', async () => {
                if (!currentRoomDocRef) {
                    showNotification('Aguarde, o chat ainda não está pronto.');
                    return;
                }
                const messageText = chatInput.value.trim();
                if (messageText === '') return;
                setButtonLoading(sendChatBtn, sendChatText, sendChatLoading, true);
                
                try {
                    const roomChatCollectionRef = collection(db, 'rooms', appId, 'chat');
                    await addDoc(roomChatCollectionRef, {
                        text: messageText,
                        senderName: currentUserData.displayName || 'Anônimo',
                        senderId: auth.currentUser.uid,
                        profilePicUrl: currentUserData.photoURL || '',
                        timestamp: serverTimestamp()
                    });
                    chatInput.value = '';
                    chatInput.focus();
                } catch (error) {
                    showNotification(`Erro ao enviar mensagem: ${error.message}`);
                    console.error(error);
                } finally {
                    setButtonLoading(sendChatBtn, sendChatText, sendChatLoading, false);
                }
            });

            // Allows sending a message by pressing Enter
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('send-chat-btn').click();
                }
            });

            // --- Main Logic: Observe authentication state ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userId = user.uid;
                    const userDocRef = doc(db, 'users', userId);
                    
                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (!userDoc.exists()) {
                            // Create a default profile if one does not exist
                            await setDoc(userDocRef, {
                                displayName: `Usuário ${user.email.split('@')[0]}`,
                                photoURL: '',
                                createdAt: serverTimestamp()
                            });
                            currentUserData = (await getDoc(userDocRef)).data();
                            showNotification('Perfil criado automaticamente. Clique em "Editar Perfil" para personalizá-lo.');
                        } else {
                            currentUserData = userDoc.data();
                        }

                        // Initialize the room and chat
                        currentRoomDocRef = doc(db, 'rooms', appId);
                        
                        // Create the room document if it does not exist
                        const roomDoc = await getDoc(currentRoomDocRef);
                        if (!roomDoc.exists()) {
                            await setDoc(currentRoomDocRef, {
                                videoURL: "",
                                isPlaying: false,
                                timestamp: 0,
                                lastUpdatedBy: "",
                                lastUpdateTimestamp: 0
                            });
                        }

                        // Observe the room state in real-time
                        onSnapshot(currentRoomDocRef, (doc) => {
                            const roomData = doc.data();
                            if (roomData) {
                                if (videoPlayer.src !== roomData.videoURL) {
                                    videoPlayer.src = roomData.videoURL;
                                }
                                
                                // Sync playback state
                                const currentTime = videoPlayer.currentTime;
                                const remoteTime = roomData.timestamp;
                                const timeDifference = Math.abs(currentTime - remoteTime);

                                if (roomData.isPlaying && timeDifference > 2 && roomData.lastUpdatedBy !== user.uid) {
                                    videoPlayer.currentTime = remoteTime;
                                    showNotification(`Sincronizando com o host. Tempo: ${Math.floor(remoteTime)}s`);
                                    videoPlayer.play();
                                } else if (!roomData.isPlaying && roomData.lastUpdatedBy !== user.uid) {
                                    videoPlayer.pause();
                                }
                            }
                        }, (error) => {
                            console.error("Erro ao observar a sala:", error);
                            showNotification("Erro ao conectar à sala. Verifique suas permissões.");
                        });
                        
                        // Observe chat messages in real-time
                        const roomChatCollectionRef = collection(db, 'rooms', appId, 'chat');
                        const q = query(roomChatCollectionRef, orderBy('timestamp'));
                        
                        onSnapshot(q, (snapshot) => {
                            if (!chatMessagesInitialized) {
                                chatMessages.innerHTML = '';
                                renderedMessageIds.clear(); // Clear the set on initial load
                                chatMessagesInitialized = true;
                            }
                            
                            const chatPlaceholder = document.getElementById('chat-placeholder');
                            if (chatPlaceholder) {
                                if (snapshot.size > 0) {
                                    chatPlaceholder.classList.add('hidden');
                                } else {
                                    chatPlaceholder.classList.remove('hidden');
                                }
                            }
                            
                            snapshot.docChanges().forEach((change) => {
                                if (change.type === "added") {
                                    const messageId = change.doc.id;
                                    if (!renderedMessageIds.has(messageId)) {
                                        const message = change.doc.data();
                                        const isMyMessage = message.senderId === user.uid;
                                        const messageElement = document.createElement('div');
                                        messageElement.classList.add('flex', 'items-start', 'space-x-3', 'mb-2');
                                        
                                        const messageBubble = document.createElement('div');
                                        messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-[75%]', 'break-words');
                                        
                                        if (isMyMessage) {
                                            messageBubble.classList.add('bg-white', 'text-black', 'ml-auto');
                                        } else {
                                            messageBubble.classList.add('bg-gray-700', 'text-white');
                                        }
                                        
                                        const senderName = document.createElement('p');
                                        senderName.classList.add('text-xs', 'font-bold', 'mb-1', isMyMessage ? 'text-right' : 'text-left');
                                        senderName.textContent = message.senderName;
                                        
                                        const messageText = document.createElement('p');
                                        messageText.textContent = message.text;
                                        
                                        messageBubble.appendChild(senderName);
                                        messageBubble.appendChild(messageText);
                                        messageElement.appendChild(messageBubble);
                                        
                                        chatMessages.appendChild(messageElement);
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                        renderedMessageIds.add(messageId);
                                    }
                                }
                            });
                        }, (error) => {
                             console.error("Erro ao observar o chat:", error);
                             showNotification("Erro ao conectar ao chat. Verifique suas permissões.");
                        });
                        
                        // Enable buttons and show the app screen
                        loadVideoBtn.disabled = false;
                        sendChatBtn.disabled = false;
                        showScreen('app');

                    } catch (error) {
                        console.error("Erro no fluxo de autenticação:", error);
                        showNotification(`Erro ao carregar dados do usuário: ${error.message}`);
                        showScreen('auth'); // Return to the authentication screen
                    }

                } else {
                    // User is logged out
                    showScreen('auth');
                }
            });
        };
    </script>
</body>
</html>
